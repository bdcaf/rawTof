---
title: "Example usage using an object to cache reused data"
author: "Clemens Ager"
date: "`r Sys.Date()`"
output: 
  rmarkdown:::html_vignette
vignette: >
  %\VignetteIndexEntry{Do it with objects}
  %\VignetteKeyword{example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Using objects

To speed up reading it makes sense to keep reopening and closing files to
a minimum.

_Note:_ make sure to cleanup after usage using ```finalize(obj)```.

```{r}
tof_file <- system.file("extdata","breath.h5", package="tofExampleData")
```

```{r library, include = F, eval=F}
devtools::load_all()
```

## create the object

```{r}
tof_ob <- new("TofClass", filename=tof_file)
```

## get the sum spectrum

```{r}
sumspec <- sumspec(tof_ob)
plot(sumspec, type="l")
```


## get spec at index

```{r}
aspec <- scan_ind(tof_ob,23)
plot(aspec, type="l")
```

## timing information

```{r}
timing <- get_timing(tof_ob@.datafile)
```


## get a block

This is usefull for manual integration.  It uses the notation of
`rhdf5` of start point and number of elements.

```{r}
sblock <- scan_block(tof_ob, ind = c(150500,200))

```

```{r, fig.cap = "spectrum of block" }
plot( apply(sblock, 1, sum), type="l")
```

```{r, fig.cap = "simple integration of block"}
plot(timing, apply(sblock, 2, sum), type="l")
```




### attributes 

```{r}
gg <- H5Gopen(tof_ob@.datafile, "FullSpectra")
ao <- H5Aopen(gg, "Single Ion Signal")
at <- H5Aread(ao)
```

### get dimension info

```{r}
h5f <- H5Fopen(tof_file)
extents <- dim(h5f$`FullSpectra/TofData`)
aSpec <- h5f$`FullSpectra/TofData`[,1,2,3]
plot(aSpec,type="l")
```

### cleaning

It helps to close all open connections.  `rhdf5` seems unable to do it
by itself.  Might be good to wrap this in `on.exit`.

```{r}
finalize(tof_ob)
```
